<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ScamGuard ‚Äì Analyse</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { border-radius: 16px; box-shadow: 0 12px 24px rgba(0,0,0,.06) }
  </style>
</head>
<body class="min-h-screen bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-orange-50 via-white to-orange-100 text-gray-800">

  <div class="max-w-5xl mx-auto px-6 py-10">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center gap-3 mb-2">
        <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-orange-100">üõ°Ô∏è</span>
        <h1 class="text-4xl md:text-5xl font-black tracking-tight">ScamGuard</h1>
      </div>
      <p class="text-gray-600">Analyse d‚Äôannonce Leboncoin en temps r√©el</p>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden card bg-white border border-orange-200 p-6 mb-8">
      <div class="flex items-center gap-3">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"></div>
        <span class="text-lg font-medium">Analyse en cours‚Ä¶</span>
      </div>
      <div class="w-full bg-gray-100 rounded-full h-3 mt-4 overflow-hidden">
        <div id="progress-bar" class="bg-gradient-to-r from-orange-500 to-orange-600 h-3 rounded-full transition-all" style="width: 15%;"></div>
      </div>
    </div>

    <!-- Error -->
    <div id="error" class="hidden card bg-red-50 border border-red-200 p-4 mb-6 text-red-700"></div>

    <!-- Results -->
    <div id="results" class="hidden space-y-6"></div>
  </div>

  <script>
    // ============ CONFIG ============
    // ‚ö†Ô∏è Mets ici le bon domaine Netlify de TON site
    // (tu m‚Äôas donn√© celui-ci qui r√©pond bien) :
    const API_URL = "https://scamguard-netlify.netlify.app/.netlify/functions/analyze";
    // ================================

    console.log("üöÄ analyze.html charg√©");
    const qs = new URLSearchParams(location.search);
    const dataParam = qs.get("d");

    function decodeData(b64) {
      try {
        const json = decodeURIComponent(escape(atob(b64)));
        return JSON.parse(json);
      } catch (e) {
        console.error("‚ùå Erreur de d√©codage Base64 :", e);
        return null;
      }
    }

    const annonce = dataParam ? decodeData(dataParam) : null;
    console.log("üì¶ Donn√©es re√ßues depuis l‚Äôextension :", annonce);

    const elLoading = document.getElementById("loading");
    const elBar     = document.getElementById("progress-bar");
    const elError   = document.getElementById("error");
    const elResults = document.getElementById("results");

    const safeText = (v, fallback="") => (v == null || v === "" ? fallback : v);
    const asList   = (arr) => (Array.isArray(arr) && arr.length ? arr : []);

    function riskPill(level) {
      if (level === "high")   return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-red-100 text-red-700 text-sm">üö® Risque √©lev√©</span>`;
      if (level === "medium") return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-orange-100 text-orange-700 text-sm">‚ö†Ô∏è Risque mod√©r√©</span>`;
      return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-green-100 text-green-700 text-sm">‚úÖ Faible risque</span>`;
    }

    async function analyze() {
      if (!annonce || !safeText(annonce.title)) {
        elError.textContent = "‚ùå Aucune donn√©e re√ßue. Cliquez depuis une annonce Leboncoin.";
        elError.classList.remove("hidden");
        return;
      }

      elLoading.classList.remove("hidden");
      elBar.style.width = "35%";

      try {
        console.log("üì° POST vers API :", API_URL);
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data: annonce })
        });

        elBar.style.width = "65%";
        console.log("üì® Statut HTTP :", res.status);

        const raw = await res.text();
        console.log("üßæ R√©ponse brute :", raw);

        let json;
        try { json = JSON.parse(raw); }
        catch { throw new Error("R√©ponse API invalide (non-JSON)"); }

        if (!json.success) {
          throw new Error(json.error || "Erreur API");
        }

        const d = json.data || {};
        // valeurs par d√©faut s√ªres
        const score = Number.isFinite(d.overall_score) ? d.overall_score : 60;
        const risk  = safeText(d.risk_level, "medium");
        const reds  = asList(d.red_flags);
        const greens= asList(d.green_flags);

        elBar.style.width = "100%";
        elLoading.classList.add("hidden");

        elResults.innerHTML = `
          <!-- R√©sum√© -->
          <div class="card bg-white border border-orange-200 p-6">
            <h2 class="text-xl font-bold mb-3 flex items-center gap-2">
              <span>üìä R√©sultat de l'analyse</span>
            </h2>

            <h3 class="text-2xl md:text-3xl font-extrabold text-orange-600 leading-tight">
              ${safeText(d.title, annonce.title)}
            </h3>

            <div class="mt-2 text-gray-700">
              <div>Score global : <strong>${score}</strong>/100</div>
              <div class="mt-1">${riskPill(risk)}</div>
              <p class="mt-3 text-gray-600">${safeText(d.recommendation, "Analyse termin√©e.")}</p>
            </div>
          </div>

          <!-- Points d‚Äôattention -->
          <div class="card bg-rose-50 border border-rose-200 p-6">
            <h3 class="text-lg font-bold text-rose-800 mb-3">üö© Points d'attention</h3>
            ${
              reds.length
                ? `<ul class="list-disc ml-6 space-y-1 text-rose-700">${reds.map(f => `<li>${f}</li>`).join("")}</ul>`
                : `<div class="text-rose-700/70">Aucun signal d√©tect√©</div>`
            }
          </div>

          <!-- Points positifs -->
          <div class="card bg-green-50 border border-green-200 p-6">
            <h3 class="text-lg font-bold text-green-800 mb-3">‚úÖ Points positifs</h3>
            ${
              greens.length
                ? `<ul class="list-disc ml-6 space-y-1 text-green-700">${greens.map(f => `<li>${f}</li>`).join("")}</ul>`
                : `<div class="text-green-700/70">Aucun √©l√©ment mis en avant</div>`
            }
          </div>
        `;
        elResults.classList.remove("hidden");
      } catch (err) {
        console.error("‚ùå Erreur analyze():", err);
        elLoading.classList.add("hidden");
        elError.textContent = "‚ùå " + err.message;
        elError.classList.remove("hidden");
      }
    }

    analyze();
  </script>
</body>
</html>
